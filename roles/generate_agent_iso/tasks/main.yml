---
- name: Create cluster install dir
  ansible.builtin.file:
    path: "{{ item }}"
    mode: '0755'
    state: directory
  with_items:
    - "{{ openshift_cluster_install_dir }}"
    - "{{ openshift_cluster_config_dir }}"

- name: Generate RSA ssh keys
  ansible.builtin.command:
    cmd: "ssh-keygen -t rsa -b 2048 -f {{ ssh_key }} -N ''"
    creates: "{{ ssh_key}}"
  register: ssh_keygen
  changed_when: ssh_keygen.rc == 0

- name: Set fact for {{ ip_space }} IPv4 address
  set_fact:
    ipv4_address: "{{ ansible_all_ipv4_addresses | select('match', '^' + ip_space + '\\.') | list }}"
  when: ipv4_address is undefined

- name: Generate agent-config.yaml
  ansible.builtin.template:
    src: "{{ item }}.j2"
    dest: "{{ openshift_cluster_install_dir }}/{{ item }}"
    mode: '0644'
  with_items:
   - install-config.yaml
   - agent-config.yaml

- name: Create copys of agent-config and install configuration
  ansible.builtin.copy:
    src: "{{ openshift_cluster_install_dir }}/{{ item }}"
    dest: "{{ openshift_cluster_install_dir }}/{{ item }}-copy"
    remote_src: yes
  with_items:
   - install-config.yaml
   - agent-config.yaml

- name: Generate ISO
  ansible.builtin.command:
    cmd: openshift-install agent create image --dir {{ openshift_cluster_install_dir }}